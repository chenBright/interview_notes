# main函数前后发生了什么

## 在 main函数之前发生了什么

对于编程人员来讲，`main`函数是程序的入口，但事实上`main` 函数之前也发生了很多操作。在 `main` 函数开始前，分成两部分 “系统调用部分” 和 “C++ 程序自身的部分”。

我们首先假设程序的`main`函数原型是`int main(int argc, char *argv[]);`，其中，`argc` 指命令行参数的数目， `argv` 是指向参数的各个指针所构成的数组。

### 系统调用部分

对于 Linux 系统而言，当内核执行 C 程序时使用 `exec` 函数，在调用 `main` 前先调用一个特殊的启动例程。可执行文件将此启动例程指定为程序的起始地址。启动例程从内核取得命令行参数和环境变量值。

1. 简而言之，系统会为你设置**栈**，并且将`argc`、`argv`和`envp`压入栈中。文件描述符 0、1 和 2`（stdin, stdout和stderr）`保留 shell 之前的设置。
2. 加载器会帮你完成**重定位**，调用你设置的预初始化函数。
3. 当所有搞定之后，控制权会传递给`_start()`，即程序的入口函数。

### 程序本身的 main() 执行前

1. 入口函数对运行库和程序运行环镜进行初始化，包括栈、堆、I/O、线程、全局变量构造等等。
2. 入口函数完成初始化后，调用 main 函数，正式开始执行程序主体部分。

## main() 结束之后呢？

1. `main`函数执行完毕后，返回到入口函数，入口函数进行**清理工作**，包括全局变量的析构、堆销毁、关闭I/O 等，然后系统调用结束进程。

- `main`函数结束可以通过 `return 0;`或者 `exit(0)` 来结束，此时程序并非直接结束，而是先调用一些终止处理程序然后再结束。可以使用`int atexit(void (*func)(void));`来追加自定义终止处理程序，终止处理程序由 `exit`函数自动调用，调用顺序与登记顺序相反。
- 如果`main`函数发生了异常或者使用`_exit`和`_Exit`来退出程序，则不会调用终止处理程序。

## mian() 之前执行一条语句

- [C/C++中如何在main()函数之前执行一条语句？](https://www.zhihu.com/question/26031933)
- [如何让一段程序在main函数之前执行](https://www.cnblogs.com/lfri/p/12421251.html)

## 参考

- [搞定技术面试-在 main函数之前发生了什么](https://juejin.im/post/5e0450d86fb9a016214ce037)
- [C语言深度总结[全面认识main函数之前运行代码]](https://www.jianshu.com/p/4260d859f181)